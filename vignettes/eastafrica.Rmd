---
title: "Policy simulation for East Africa"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_notebook:
    number_sections: yes
    toc: yes
    toc_depth: 2
---

# Setup
```{r}
#--------------------------------------------------------------------------------
# Run anything of substance?
#--------------------------------------------------------------------------------
# Set default to FALSE, so it doesn't stall building the package
runNow <- TRUE
# Define nsims here
nsims <- 10

#-------------------------------------------------------------------------------
# Setup 
#-------------------------------------------------------------------------------
library(reshape)
library(parallel)
library(ggplot2)
library(knitr)
library(plyr)
library(bcimodel)
data(ex1)

#--------------------------------------------------------------------------------
# Knitr
#--------------------------------------------------------------------------------
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

# Set up inputs

## Initialize stats holder object
This is perhaps better done in a .csv file and then imported?
```{r}
#-------------------------------------------------------------------------------
# Stats will be contained in "eafr" list object
#-------------------------------------------------------------------------------
eafr <- vector('list', length=length(ex1))
(names(eafr) <- names(ex1))
```

## Define policies to investigate

Note: baseline % advanced = 78%
```{r}
eafr$pol  <- data.frame(num=c(1:10),
                         id=c('adv78', 
                              'adv78.tam', 'adv78.tamchemo', 'adv78.tamchemoERpos',
                              'adv60.tam', 'adv60.tamchemo', 'adv60.tamchemoERpos',
                              'adv35.tam', 'adv35.tamchemo', 'adv35.tamchemoERpos'
                              ),
                         name=c('T0: Surgery only', 'T1: Tamoxifen for ER+', 
                                'T2: T1 plus Chemo for ER-',
                                'T3: T2 plus Chemo for Advanced ER+', 
                                'T1 plus downstaging to 60% advanced',
                                'T2 plus downstaging to 60% advanced',
                                'T3 plus downstaging to 60% advanced',
                                'T1 plus downstaging to 35% advanced',
                                'T2 plus downstaging to 35% advanced',
                                'T3 plus downstaging to 35% advanced'),
                         pairnum=c(NA, NA, NA, NA, rep(c(2,3,4), 2)),
                         earlydetHR=c(rep(1, 4), rep(0.60/0.78, 3),
                                      rep(0.35/0.78, 3)),
                         stringsAsFactors=FALSE)
kable(eafr$pol)
```

## Define natural history parameters

### Stage and ER+
Advanced-stage is 78% and proportion ER+ is 41%. 

### Mortality rates
If we use Galakunde and Culter (US), mortality rates correspond to 35% 5-year survival for advanced and 80% 5-year survival for early.

From Kantehardt metastasis-free survival curve and using GraphClick, we get the coordinates of 80% surviving at 3 years for stage 1+2, 54.7% surviving at 3 years for stage 3. Translating those to 5-yr survivals:
```{r}
kantehardt.early.m <- cumsurv_to_exprate(0.80, year=3)
kantehardt.late.m <- cumsurv_to_exprate(0.547, year=3)
(kantehardt.early.surv <- exp(-5*kantehardt.early.m))
(kantehardt.late.surv <- exp(-5*kantehardt.late.m))
```

But actually, the other Kantehardt reference gives these 5-year survivals:
```{r}
early.5yr = 0.72
adv.5yr = 0.33
```

#### Math for no-Tamoxifen mortality rate among ER+
Variables: 

Description | Notation | Value
--------------------------------- | -------- | ---------------------
Proportion of cases that are ER positive | $p_{ER+}$ | 0.72
Presumed proportion of ER+ treated with Tamoxifen | $t$ | 0.57
Hazard ratio for Tamoxifen | $h$ | 0.7
Observed mortality rate, all | $m_{o}$ | 0.028 (early) or 0.120 (adv)
Observed 5-year survival, all | $S_{o}$ | 0.028 (early) or 0.120 (adv)
Baseline mortality rate, ER- | $m_{ER-}$ | To be estimated
Baseline mortality rate, ER+ | $m_{ER+}$ | To be estimated
Baseline mortality rate, ER+, no Tamoxifen | $m_{b}$ | To be estimated
Baseline 5-year survival, ER- | $S_{ER-}$ | To be estimated
Baseline 5-year survival, ER+ | $S_{ER+}$ | To be estimated
Baseline 5-year survival (no Tamoxifen), ER+ | $S_{b}$ | To be estimated

##### On the hazard scale
_Abandoned this because hazard is a conditional probability, and conditioning on survival to time t for ER+ and ER- is not equivalent_

For each stage-specific mortality for ER+ women, observed mortality is a weighted sum of those who do not receive Tamoxifen and those who do,

$m_{o} = p_{ER+}m_{ER+} + (1-p_{ER+})m_{ER-}$

$m_{ER+} = (1-t)m_{b} + thm_{b}$

Let us assume that $m_{ER-}$ = $m_{b}$, i.e. there is equal chemotherapy in both ER groups and thus mortality is the same when the benefit of Tamoxifen is removed. Then our expression for $m_{obs}$ simplifies as follows:

$m_{o} = p_{ER+}[(1-t)m_{b} + thm_{b}] + (1-p_{ER+})m_{b}$

$m_{b} = \frac{m_{o}}{p_{ER+}(1-t) + p_{ER+}th + (1-p_{ER+})}$

$S_{b} = e^{-5*m_{b}}$

##### On the survival scale, at 5 years
Using the similar assumption that $S_{ER-}$ = $S_{b}$, i.e. there is equal chemotherapy in both ER groups and thus survival is the same when the benefit of Tamoxifen is removed.

$S_{o} = p_{ER+}[(1-t)S_{b} + t(S_{b})^h] + (1-p_{ER+})S_{b}$

$0 = p_{ER+}(1-t)S_{b} + p_{ER+}t(S_{b})^h + (1-p_{ER+})S_{b} - S_{o}$

This is a fractional polynomial:

**EARLY STAGE**
```{r}
# Early stage
f = function(x, p=0.41, t=1, h=0.7, So=early.5yr) { p*(1-t)*x + p*t*x^h + (1-p)*x - So}
str(Sb.early <- uniroot(f, lower=0.5, upper=early.5yr, tol = 0.0001))
(early.mrate = cumsurv_to_exprate(Sb.early$root, year=5))
```

**ADVANCED STAGE - JUST CURIOUS**
```{r}
# Advanced stage - just out of curiosity. Since the Kalendehardt data are actually mets-free survival, not survival, it's a worse approx for advanced stage than it is for early stage. 
f = function(x, p=0.41, t=1, h=0.7, So=adv.5yr) { p*(1-t)*x + p*t*x^h + (1-p)*x - So}
str(Sb.adv <- uniroot(f, lower=0.2, upper=adv.5yr, tol = 0.0001))
# Rate from Galukande
(cumsurv_to_exprate(Sb.adv$root, year=5))
```

We'll still use Galukande, 5-yr surv of 35%:
```{r}
(adv.mrate <- cumsurv_to_exprate(0.35, year=5))
```

```{r}
eafr$nh <- compile_naturalhist(prop_adv=0.78, 
                 mortrates=c(Early=early.mrate, Advanced=adv.mrate),
                 subgroup_probs=c(`ER+`=0.41, `ER-`=0.59))
kable(eafr$nh[,c('stage', 'subgroup', 'mortrate', 'prop')])
```

The "map" assigns numeric id's to each stage-subgroup. The stage-shifting will keep ER status constant, e.g. stage #3 shifts to #1 and stage #4 shifts to #2.
```{r}
(eafr$map <- create_stageshift_map(eafr$nh))
```

# Specify treatment for each policy

According to the policies defined above, there are 4 treatment scenarios: T0, T1, T2 and T3. We will define those for the no-stage-shift policies, and then copy them over for the 2 other stage shifts. 
```{r}
eafr$tx <- data.frame(expand.grid(txSSid=c('None', 'Tamoxifen', 'Chemo',
                                           'Tamoxifen+Chemo'),
                                     SSno=1:nrow(eafr$nh)),
                      stringsAsFactors=FALSE)
ntreat <- nrow(eafr$tx)
ntx <- length(unique(eafr$tx$txSSid))

# Proportions sum to 1 within stage-subgroup groups
eafr$tx <- transform(eafr$tx, 
                     SSid=c(rep('Early.ER+', ntx), rep('Early.ER-', ntx), 
                            rep('Advanced.ER+', ntx), rep('Advanced.ER-', ntx)), 
                     txSSno=1:ntreat)
eafr$tx <- transform(eafr$tx,
                        txHR=c(1, 0.7, 0.775, 0.775*0.7, 
                               1, 1, 0.775, 0.775,
                               1, 0.7,  0.775, 0.775*0.7,
                               1, 1, 0.775, 0.775))
adv78 <- adv78.tam <- rep(0, ntreat)
txSSid <- as.character(eafr$tx$txSSid)
SSid <- as.character(eafr$tx$SSid)
adv78[txSSid=='None'] <- 1 
adv78.tam[txSSid=='Tamoxifen' & (SSid=='Early.ER+' | SSid=='Advanced.ER+')] <- 1
adv78.tamchemo <- adv78.tam
adv78.tam[txSSid=='None' & (SSid=='Early.ER-' | SSid=='Advanced.ER-')] <- 1
adv78.tamchemo[txSSid=='Chemo' & (SSid=='Early.ER-' | SSid=='Advanced.ER-')] <- 1
adv78.tamchemoERpos <- adv78.tamchemo
adv78.tamchemoERpos[txSSid=='Tamoxifen' & SSid=='Advanced.ER+'] <- 0
adv78.tamchemoERpos[txSSid=='Tamoxifen+Chemo' & SSid=='Advanced.ER+'] <- 1

props <- data.frame(adv78, 
               adv78.tam, adv78.tamchemo, adv78.tamchemoERpos,
               adv78.tam, adv78.tamchemo, adv78.tamchemoERpos,
               adv78.tam, adv78.tamchemo, adv78.tamchemoERpos)
colnames(props) <- eafr$pol$id

eafr$tx <- data.frame(eafr$tx, props, stringsAsFactors=FALSE)

eafr$tx <- data.frame(eafr$tx, stringsAsFactors=FALSE)

kable(eafr$tx)
```

# Incidence
We are using Uganda for our East Africa example.
```{r}
data(incratesf)
theserates <- subset(incratesf,
                     Country %in% c('United States', 'Uganda',
                                    'Malawi', 'South Africa', 
                                    'Zimbabwe', 'Tunisia'))
plot_rates(theserates$Age, theserates$Female.Rate.Per.100K,
                      psize=theserates$Cases, 
                      group=paste(theserates$Country, theserates$Year))
```

# System time
```{r}
#-------------------------------------------------------------------------------
# Simulate policies - example data
#-------------------------------------------------------------------------------

if (1==0) {
    # 50 sims
    # Timing it. Parallelizing is definitely faster but computer did heat up a lot more.
    t1 <- system.time(simpolicies(ex1$pol, ex1$nh, ex1$tx, sims=50)) #311 seconds
    t2 <- system.time(parsimpolicies(ex1$pol, ex1$nh, ex1$tx, sims=50)) #161 seconds
}
```

# Results for East Africa, ages 30-49

## Run model
```{r, echo=TRUE}
#-------------------------------------------------------------------------------
# Ages 30-49
#-------------------------------------------------------------------------------

if (runNow) {
    # Model
    startclock <- proc.time()
    manuscript_eastafrica <- parsimpolicies(eafr$pol, eafr$nh, eafr$tx, 
                                          incsource='Uganda',
                                          mortsource='Uganda', 
                                          returnstats=c('mean', 'lower', 
                                                        'upper'), 
                                          futimes=c(5,10,20), 
                                          minage=30, maxage=49, sims=nsims)
    # Runtime in minutes
    runtime_minutes <- (proc.time()-startclock)/60
    # Format and save results
    finaltab <- format_bounds_list(manuscript_eastafrica, 
                                   paren=TRUE, includemean=TRUE, 
                                   digits=c(0,0,1,2,0,0),
                                   compileall=TRUE)
    write.csv(finaltab, file=paste0('eastafrica_', nsims, 'sims.csv'),
                                    row.names=FALSE)
}
```

## Runtime
Runtime in minutes:
```{r, echo=TRUE}
runtime_minutes
```

## Results
RESULTS FOR `r nsims` SIMS:
```{r}
library(pander)
panderOptions('keep.line.breaks', TRUE)
statwidth <- 1.25*100/ncol(finaltab)
fuwidth <- 0.5*statwidth
cellwidths <- (100-statwidth-fuwidth)/ncol(finaltab)
allwidths <- round(c(fuwidth, statwidth, 
                     rep(cellwidths, (ncol(finaltab)-2))),2)
allwidths[2] <- allwidths[2]+(100-sum(allwidths))
widths <- paste0(allwidths, '%')
# charwidths=c(2, 20, rep(10, ncol(finaltab)-2))
# if (runNow) pander(finaltab, split.cells=widths)
# if (runNow) pander(finaltab)
# Note, it was very difficult to get the table to look right. There were
# some combinations of parameters that did not work. e.g. having split.tables=175 or 250
# I gave up - removed the "\n" from format_bounds and went back to " "
# if (runNow) pandoc.table(finaltab, split.cells=widths, split.tables=165)
if (runNow) kable(finaltab)
```

```{r, fig.height=10}
rlong <- compile_long(manuscript_eastafrica)
rplot <- plot_results(rlong, type='line')
rplot
```

```{r, fig.height=10}
rplot <- plot_results(rlong, type='bar')
rplot
```

# Comments

